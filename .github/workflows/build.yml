name: Build APK (Plan D)
on: [push]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      # 1. Explicitly setup Java 17 (Required for Android)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 2. Explicitly setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 3. FORCE accept all licenses (This prevents the freeze!)
      - name: Accept Licenses
        run: yes | sdkmanager --licenses || true

      # 4. Install system dependencies
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev ffmpeg libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev libtool automake autoconf nasm

      # 5. Setup Python and Buildozer
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Buildozer
        run: pip install buildozer cython==0.29.33

      # 6. Build the APK
      - name: Build APK
        run: |
          # Ensure icon exists
          if [ ! -f icon.png ]; then wget https://raw.githubusercontent.com/kivy/kivy/master/kivy/data/logo/kivy-icon-64.png -O icon.png; fi
          
          # Run buildozer (The 'yes' pipe is a backup)
          yes | buildozer android debug

      - uses: actions/upload-artifact@v4
        with:
          name: package
          path: bin/*.apk
